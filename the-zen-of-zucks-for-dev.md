# The Zen of Zucks 開発編

基本的には [The Zen of Python](https://peps.python.org/pep-0020/) で間に合います。
そちらも参照してください。

日本語資料は以下を参照してください。

- 和訳
  - https://qiita.com/IshitaTakeshi/items/e4145921c8dbf7ba57ef
- 解説
  - https://atsuoishimoto.hatenablog.com/entry/20100920/1284986066
  - https://atsuoishimoto.hatenablog.com/entry/20100926/1285508015

## 一般的なこと

### 不安があるなら相談しよう

レビューしてもらうのはコードに限った話だけではないです。
リリース方法やリリース後の確認の仕方、方針でもなんでも。
自分の中に少しでも不安があるなら言語化して、それをチームのメンバーに相談もしくはレビューをしてもらいましょう。

### 推測するな､計測せよ

例えばパフォーマンスチューニングをする際､推測と当てずっぽうでコードを修正しても成果はなかなか得られません｡
そんなときはプロファイラなどを仕掛けてボトルネックとなっているところを計測しましょう｡

### 観測した事実と考察を分ける

上記と似たような話ですが､調査系のIssueにおいては「**観測した結果としての事実**」と､「**事実からの考察**」はどちらなのかわかるように書きましょう｡
事実と考察がセットで書かれていると何が事実なのか・考察なのかが入り混じってしまい他の人の状況把握が遅れてしまいます。
事実であれば調査方法と結果を合わせて書いておくと他の人が検証できるようになります｡


## 開発関連

### GitHubは分報

作業のログは逐一 GitHub Issue/PR に書いていくといいでしょう｡その際に考えたことや、悩んでいること、これからやろうとしていることなども書いておくとよいです｡
細かくアウトプットしておくと、早いタイミングで周囲のメンバーから気になるポイントの指摘や、アドバイスなどのフィードバックを得やすくなります。

また、あとに続く人が同じような作業をする際に、既存Issueを検索するとヒントがでてくるようになります｡

### Issueからはじめよ

何らかの仕事を依頼されたときは､まず GitHub リポジトリに Issue を作りましょう｡
その際にはやり取りが行われた場所へのリンクや､タスクの概要を書いておくと親切です(例: SlackメッセージのURL)

人間の記憶力や注意力は有限です｡仕掛中の仕事を先に済ます場合は､終えたあとに「取り掛かるぞ!」となった際に忘れてしまうことは多々あります｡
そうならないように普段からタスクはIssueに書き出しておくことをおすすめします｡

また､タスクの概要が書いてあれば起票者だけでなく他の人でも取り掛かれるようになります｡

### PRはレビューしてもらおう

PRを作ったら原則レビューしてもらいましょう｡
自分がどんな仕事をしているのか､どんなものを作っているのかを他の人に知ってもらうことはバス係数を増やすことに繋がります｡


### 全てはなるはや

私たちは課題に取り組む上で締切を設けることはほとんどありません｡
私たちは常に事業にとって何を最も優先すべきかを考え、それを元にたくさんある課題の中から優先度を決め、取り組みます｡
つまり、私たちが取り組む課題は常に事業にとって今すぐにでも欲しいものなのです｡
私たちは工数を見積もるよりも今そこにある課題をサービスの質を落とさず、どうやってなるはやで解決するかに注力します｡

### PRは確認する範囲を小さく

一個のPRが大きすぎるのはよくないサインです｡
大きなPRは

- レビュワーの負担増
- リリース後の確認ポイントが多い
- 手戻りが発生すると大変

という問題があります｡

例えばAサーバーからBサーバーへ何らかのリクエストを送り､その結果をXという処理使うというケースを考えてみます｡
この場合は最小確認単位ごとにリリースをしていくといいでしょう｡

- A -> B のリクエストが正しく送れてレスポンスが受け取れる
- Xという処理にBの結果を渡して処理する

というような分割をします｡

### ドキュメントを作る前に保守コストに見合うか考えよう

GithubのREADME.mdや機能の詳細な仕様をまとめたdocs、ソースコードのコメントなどは全てドキュメントです。
それらのドキュメントは基本的にはソフトウェアの挙動変更に追従して変更されるものではないので、維持するためにコストが掛かります。

ドキュメントは後に機能を触る人(数ヶ月後の自分も含めて)のためのものですが、
Zucksはエンジニアの出入りが激しい部署ではないのでドキュメントで節約できる時間よりも保守の時間のほうが上回る場合が多いです。

ドキュメントを作るとき「このドキュメントは本当に必要なのか」「コードの変更に追従させることはできないのか」
「そもそもドキュメントがなくても分かるものにできないのか」などを考えてドキュメントを作ることを意識しましょう。

## デプロイ関連

この項目は

- 高速なトライアンドエラー
- 高頻度リリース

などを実現するためのものです｡


### リバートが容易な単位でリリースする

変更の単位はリバートが容易であるかどうかを意識しましょう｡
リリース後に何かしらの問題が発生した場合には変更をリバートしてリリースするだけで済むようになります｡
リバートすれば済む状態を作っておくことでリリースしたことによる問題に誰でも対処できるようになります｡

リバートが容易でない例としては
- マイグレーションで drop columnするので元のデータが失われる
- データベースの内容を不可逆に変更するバッチ
- 同じパスに出力されるログのフォーマットが変更される

などの破壊的変更が該当します｡
リリースが破壊的な変更を伴うような場合は慎重になる必要があります｡
ペアリリースなどの手段を検討しましょう｡


### 本番でテストしよう

広告配信のリクエスト量は膨大であり､手元の環境で再現するのはほぼ不可能です｡
そんなときは､思い切って本番にテストインスタンスをアタッチして実験してみましょう｡

ただし､ずっとアタッチしっぱなしにするのはよくありません｡必要な検証ができたら速やかに終了しましょう｡
エラーが起きてもデタッチしましょう｡


### 失敗しよう

失敗を恐れずにデプロイ・リリースしましょう｡
ただし､無謀・無策で突撃するのはだめです｡
リリースの際に心配なことがあるときは、心配を言語化してPRに書いておくとレビュワーがアドバイスをくれるはずです｡
相談してみたら失敗しても影響が少ない状況を作って確認できないかを考えましょう｡

上記のようにリバートを容易にしておくことで失敗してもダメージが少なくなります｡

また失敗に気付けるように、リリース後に何を確認すればよいのかを事前に整理しておきましょう。
期待通りの挙動をしているか、予期せぬ悪影響を与えていないかは特に見るべきポイントです。


## サービス監視関連


### 監視項目は単純なエラーではなくサービスへの影響を見るように

例えばlambdaのエラーをそのままslackに通知していると､ただlambdaがエラーになったということしかわかりません｡
単純なエラーの検知ではなく具体的な機能への影響を監視しましょう｡

たとえばkinesis streamのコンシューマーとしてのlambdaを例としてみます。この場合､lambdaが処理するkinesis streamの遅れを監視し､エラー内容としては「XXXの処理が遅れています」などとしましょう｡


### 監視の通知は具体的なアクションを併記するように

ただエラーが発生したという通知だけだと､それによって何をしてほしいのかが何もわかりません｡

例えばインスタンスのディスク使用率が80%を超えたということを監視している場合は､単純に超えたという通知だけではなく､「80%を超えたのでspot.ioでインスタンスを入れ替えましょう」などの求められるアクションも書きましょう｡
